<!DOCTYPE html>
<html>

<head>
  <meta charset="utf8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      max-width: 480px;
      margin: auto;
      font-family: Helvetica, Arial, sans-serif;
      line-height: 1.3;
      margin-bottom: 20px;
    }
    table {
      width: 100%;
      margin-bottom: 10px;
      /* border-bottom: 1px solid #aaa; */
    }

    .label {
      width: 100px;
      text-align: center;
      font-weight: bold;
    }

    .input {

    }

    .description {
      font-size: smaller;
    }

    input[type=text], input[type=checkbox], select {
      width: 100%;
    }

    /* table:first-child {
      border-top: 1px solid #aaa;
    }
    textarea, input[type=text], input[type=number], input[type=checkbox] {
      box-sizing: border-box;
      width: 100%;
    }
    .label {
      width: 140px;
      text-align: center;
      font-weight: bold;
    }
    .desc {
      font-size: smaller;
    }
    summary {
      cursor: pointer;
    }
    #options:hover .option {
      opacity: 0.6;
    }
    #options:hover .option:hover,
    summary:hover ~ .option {
      opacity: 1 !important;
    } */
    /* .clarification {
      text-decoration: underline dotted;
      cursor: help;
    } */
    /* @media (prefers-color-scheme: dark) {
      body {
        background-color: #111;
        color: #ddd;
      }
      a {
        color: #4af;
      }
      a:visited {
        color: #b381ef;
      }
      a:active {
        color: #58f;
      }
      table.option {
        border-color: #444;
      }
    } */

    /* #phonegap-config {
      height: 100px;
    }
    #phonegap-container[data-enabled=false] .option:not(.phonegap-always-visible) {
      display: none;
    } */
  </style>
  <title>HTML Packager - forkphorus</title>
</head>

<body>
  <h1>HTML Packager</h1>

  <p>The HTML packager allows you to generate an HTML file for a Scratch project.</p>

  <ul>
    <li>Guide: <a href="guide.html">Packaging to .EXE</a> (Windows/Mac OS/Linux)</li>
    <li>Guide: <a href="android.html">Packaging to .APK</a> (Android, maybe iOS)</li>
    <li>Get Help: Create an issue on <a href="https://github.com/forkphorus/forkphorus/issues">GitHub</a></li>
  </ul>

  <div id="opts"></div>

  <p>
    <button id="package-html">Package Project</button>
  </p>

  <section id="loading-section"></section>

  <script src="../lib/details-element-polyfill.js"></script>
  <script src="../lib/jszip.min.js"></script>
  <script src="loader.js"></script>
  <script src="packer.js"></script>

  <script>
    // init file loader & assets
    const fileLoader = new Packer.FileLoader();

    fileLoader.files = [
      { type: 'style', src: 'phosphorus.css' },
      { type: 'script', src: 'lib/canvg.min.js', },
      { type: 'script', src: 'lib/fontfaceobserver.standalone.js', },
      { type: 'script', src: 'lib/jszip.min.js', },
      { type: 'script', src: 'lib/rgbcolor.js', },
      { type: 'script', src: 'lib/stackblur.min.js', },
      { type: 'script', src: 'phosphorus.dist.js', },
    ];

    fileLoader.assets = [
      { src: 'soundbank/sb2/instruments/AcousticGuitar_F3_22k.wav', },
      { src: 'soundbank/sb2/instruments/AcousticPiano(5)_A%233_22k.wav', },
      { src: 'soundbank/sb2/instruments/AcousticPiano(5)_C4_22k.wav', },
      { src: 'soundbank/sb2/instruments/AcousticPiano(5)_G4_22k.wav', },
      { src: 'soundbank/sb2/instruments/AcousticPiano(5)_F5_22k.wav', },
      { src: 'soundbank/sb2/instruments/AcousticPiano(5)_C6_22k.wav', },
      { src: 'soundbank/sb2/instruments/AcousticPiano(5)_D%236_22k.wav', },
      { src: 'soundbank/sb2/instruments/AcousticPiano(5)_D7_22k.wav', },
      { src: 'soundbank/sb2/instruments/AltoSax_A3_22K.wav', },
      { src: 'soundbank/sb2/instruments/AltoSax(3)_C6_22k.wav', },
      { src: 'soundbank/sb2/instruments/Bassoon_C3_22k.wav', },
      { src: 'soundbank/sb2/instruments/BassTrombone_A2(2)_22k.wav', },
      { src: 'soundbank/sb2/instruments/BassTrombone_A2(3)_22k.wav', },
      { src: 'soundbank/sb2/instruments/Cello(3b)_C2_22k.wav', },
      { src: 'soundbank/sb2/instruments/Cello(3)_A%232_22k.wav', },
      { src: 'soundbank/sb2/instruments/Choir(4)_F3_22k.wav', },
      { src: 'soundbank/sb2/instruments/Choir(4)_F4_22k.wav', },
      { src: 'soundbank/sb2/instruments/Choir(4)_F5_22k.wav', },
      { src: 'soundbank/sb2/instruments/Clarinet_C4_22k.wav', },
      { src: 'soundbank/sb2/instruments/ElectricBass(2)_G1_22k.wav', },
      { src: 'soundbank/sb2/instruments/ElectricGuitar(2)_F3(1)_22k.wav', },
      { src: 'soundbank/sb2/instruments/ElectricPiano_C2_22k.wav', },
      { src: 'soundbank/sb2/instruments/ElectricPiano_C4_22k.wav', },
      { src: 'soundbank/sb2/instruments/EnglishHorn(1)_D4_22k.wav', },
      { src: 'soundbank/sb2/instruments/EnglishHorn(1)_F3_22k.wav', },
      { src: 'soundbank/sb2/instruments/Flute(3)_B5(1)_22k.wav', },
      { src: 'soundbank/sb2/instruments/Flute(3)_B5(2)_22k.wav', },
      { src: 'soundbank/sb2/instruments/Marimba_C4_22k.wav', },
      { src: 'soundbank/sb2/instruments/MusicBox_C4_22k.wav', },
      { src: 'soundbank/sb2/instruments/Organ(2)_G2_22k.wav', },
      { src: 'soundbank/sb2/instruments/Pizz(2)_A3_22k.wav', },
      { src: 'soundbank/sb2/instruments/Pizz(2)_E4_22k.wav', },
      { src: 'soundbank/sb2/instruments/Pizz(2)_G2_22k.wav', },
      { src: 'soundbank/sb2/instruments/SteelDrum_D5_22k.wav', },
      { src: 'soundbank/sb2/instruments/SynthLead(6)_C4_22k.wav', },
      { src: 'soundbank/sb2/instruments/SynthLead(6)_C6_22k.wav', },
      { src: 'soundbank/sb2/instruments/SynthPad(2)_A3_22k.wav', },
      { src: 'soundbank/sb2/instruments/SynthPad(2)_C6_22k.wav', },
      { src: 'soundbank/sb2/instruments/TenorSax(1)_C3_22k.wav', },
      { src: 'soundbank/sb2/instruments/Trombone_B3_22k.wav', },
      { src: 'soundbank/sb2/instruments/Trumpet_E5_22k.wav', },
      { src: 'soundbank/sb2/instruments/Vibraphone_C3_22k.wav', },
      { src: 'soundbank/sb2/instruments/Violin(2)_D4_22K.wav', },
      { src: 'soundbank/sb2/instruments/Violin(3)_A4_22k.wav', },
      { src: 'soundbank/sb2/instruments/Violin(3b)_E5_22k.wav', },
      { src: 'soundbank/sb2/instruments/WoodenFlute_C5_22k.wav', },
      { src: 'soundbank/sb2/drums/BassDrum(1b)_22k.wav', },
      { src: 'soundbank/sb2/drums/Bongo_22k.wav', },
      { src: 'soundbank/sb2/drums/Cabasa(1)_22k.wav', },
      { src: 'soundbank/sb2/drums/Clap(1)_22k.wav', },
      { src: 'soundbank/sb2/drums/Claves(1)_22k.wav', },
      { src: 'soundbank/sb2/drums/Conga(1)_22k.wav', },
      { src: 'soundbank/sb2/drums/Cowbell(3)_22k.wav', },
      { src: 'soundbank/sb2/drums/Crash(2)_22k.wav', },
      { src: 'soundbank/sb2/drums/Cuica(2)_22k.wav', },
      { src: 'soundbank/sb2/drums/GuiroLong(1)_22k.wav', },
      { src: 'soundbank/sb2/drums/GuiroShort(1)_22k.wav', },
      { src: 'soundbank/sb2/drums/HiHatClosed(1)_22k.wav', },
      { src: 'soundbank/sb2/drums/HiHatOpen(2)_22k.wav', },
      { src: 'soundbank/sb2/drums/HiHatPedal(1)_22k.wav', },
      { src: 'soundbank/sb2/drums/Maracas(1)_22k.wav', },
      { src: 'soundbank/sb2/drums/SideStick(1)_22k.wav', },
      { src: 'soundbank/sb2/drums/SnareDrum(1)_22k.wav', },
      { src: 'soundbank/sb2/drums/Tambourine(3)_22k.wav', },
      { src: 'soundbank/sb2/drums/Tom(1)_22k.wav', },
      { src: 'soundbank/sb2/drums/Triangle(1)_22k.wav', },
      { src: 'soundbank/sb2/drums/Vibraslap(1)_22k.wav', },
      { src: 'soundbank/sb2/drums/WoodBlock(1)_22k.wav', },
      { src: 'fonts/Knewave-Regular.woff', },
      { src: 'fonts/Handlee-Regular.woff', },
      { src: 'fonts/Grand9K-Pixel.ttf', },
      { src: 'fonts/Griffy-Regular.woff', },
      { src: 'fonts/SourceSerifPro-Regular.woff', },
      { src: 'fonts/NotoSans-Regular.woff', },
      { src: 'fonts/Scratch.ttf', },
    ];
  </script>

  <script>
    var optionsContainer = document.querySelector('#opts');

    class Option {
      constructor(options) {
        // Init main structure
        this.root = document.createElement('table');
        this.root.className = 'option';

        this.labelContainer = document.createElement('td');
        this.labelContainer.className = 'label';

        this.inputContainer = document.createElement('td');
        this.inputContainer.className = 'input';

        const row = document.createElement('tr');
        row.appendChild(this.labelContainer);
        row.appendChild(this.inputContainer);
        this.root.appendChild(row);

        // Init data
        this.value = null;
      }

      label(label) {
        this.labelText = document.createElement('label');
        this.labelText.textContent = label;
        this.labelContainer.appendChild(this.labelText);
        return this;
      }

      radio(id, choices) {
        for (const i of choices) {
          const el = document.createElement('label');
          const radio = document.createElement('input');
          radio.name = id;
          radio.type = 'radio';
          radio.value = i.value;

          radio.onclick = () => {
            this.value = i.value;
          };
          if (i.checked) {
            radio.checked = true;
            this.value = i.value;
          }

          el.appendChild(radio);
          el.appendChild(document.createTextNode(i.label));
          this.inputContainer.appendChild(el);
        }
        return this;
      }

      input(options = {}) {
        const input = document.createElement('input');
        input.type = options.type || 'text';
        if (options.pattern) input.pattern = options.pattern;

        const getValue = () => {
          if (options.type === 'checkbox') {
            return input.checked;
          } else {
            return input.value;
          };
        }

        input.onchange = () => {
          this.value = getValue();
        };
        this.value = getValue();

        this.inputContainer.appendChild(input);
        return this;
      }

      select(options) {
        const el = document.createElement('select');

        for (const i of options) {
          const opt = document.createElement('option');
          opt.value = i.value;
          opt.textContent = i.label;

          if (i.selected) {
            opt.selected = true;
            this.value = i.value;
          }

          opt.onclick = () => {
            this.value = opt.value;
          };

          el.appendChild(opt);
        }

        this.inputContainer.appendChild(el);
        return this;
      }

      description(content) {
        const row = document.createElement('tr');
        row.className = 'description';

        const description = document.createElement('td');
        description.colSpan = 2;
        description.textContent = content;

        row.appendChild(description);
        this.root.appendChild(row);
        return this;
      }

      add() {
        optionsContainer.appendChild(this.root);
        return this;
      }
    }

    // var projectSource = new Option()
    //   .label('Project Source')
    //   .radio('select-project-type', [
    //     { value: 'id', label: 'Project ID', checked: true },
    //     { value: 'file', label: 'Project File', checked: false },
    //   ])
    //   .add();

    var projectId = new Option()
      .label('Project ID')
      .input({ pattern: '[0-9]+' })
      .add();

    var turbo = new Option()
      .label('Turbo Mode')
      .input({ type: 'checkbox' })
      .description('Enables Turbo Mode')
      .add();

    var username = new Option()
      .label('Username')
      .input()
      .add();

    var autoplay = new Option()
      .label('Autoplay')
      .select([
        { value: 'always', label: 'Always', selected: true },
        { value: 'never', label: 'Never' },
        { value: 'if-audio-playable', label: 'If audio can be played' },
      ])
      .add();

    function addDownloadLink(content, fileName) {
      function getBlob() {
        if (content instanceof Blob) {
          return content;
        }
        if ('TextEncoder' in window) {
          // firefox, chrome
          const encoder = new TextEncoder();
          return new Blob([encoder.encode(content)]);
        } else {
          // Using TextEncoder is the best method, but Edge doesn't support it.
          const bytes = new Array(content.length);
          for (let i = 0; i < content.length; i++) {
            bytes[i] = content.charCodeAt(i);
          }
          return new Blob([new Uint8Array(bytes)]);
        }
      }
      const link = document.createElement('a');
      const blob = getBlob();
      const size = blob.size / 1024 / 1024;
      link.href = URL.createObjectURL(blob);
      link.textContent = `Download ${fileName} (${size.toFixed(2)} MiB)`;
      link.download = fileName;
      document.body.appendChild(link);
      link.click();
    }

    document.querySelector('#package-html').onclick = async function() {
      const packager = new Packer.Packager({ fileLoader });

      packager.playerOptions.turbo = turbo.value;
      packager.playerOptions.autoplayPolicy = autoplay.value;
      packager.playerOptions.username = username.value;

      try {
        await packager.loadProjectById(projectId.value);
        const result = await packager.run();
        addDownloadLink(result, 'project.html');
      } catch (e) {
        console.error(e);
        alert('Error: ' + e);
      }
    }
  </script>

</body>

</html>
